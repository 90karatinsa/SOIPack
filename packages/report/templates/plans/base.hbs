<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>{{planDefinition.title}} - {{projectLabel}}</title>
    <style>
      body {
        font-family: 'Segoe UI', Arial, sans-serif;
        margin: 36px;
        color: #1c1c1c;
      }
      header {
        border-bottom: 2px solid #0a5c9b;
        margin-bottom: 24px;
        padding-bottom: 16px;
      }
      h1 {
        margin: 0;
        font-size: 28px;
        color: #0a5c9b;
      }
      .subtitle {
        margin-top: 6px;
        color: #3e5974;
      }
      .summary-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 12px;
        margin-top: 16px;
      }
      .summary-card {
        background: #f4f6fb;
        border-radius: 8px;
        padding: 12px 16px;
        border: 1px solid #d0d7e7;
      }
      .summary-card strong {
        display: block;
        font-size: 12px;
        letter-spacing: 0.05em;
        text-transform: uppercase;
        color: #445b78;
      }
      .summary-card span {
        font-size: 18px;
        font-weight: 600;
        color: #1c1c1c;
      }
      section {
        margin-top: 28px;
      }
      section h2 {
        font-size: 20px;
        border-bottom: 1px solid #d0d7e7;
        padding-bottom: 6px;
      }
      table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 12px;
      }
      th,
      td {
        border: 1px solid #d0d7e7;
        padding: 8px 10px;
        text-align: left;
        vertical-align: top;
      }
      th {
        background: #eef3fb;
        font-size: 12px;
        letter-spacing: 0.04em;
        text-transform: uppercase;
        color: #3b5773;
      }
      .status-pill {
        display: inline-block;
        padding: 3px 12px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: 600;
      }
      .status-covered {
        background: #e2f6ea;
        color: #1f7a39;
      }
      .status-partial {
        background: #fff2cc;
        color: #8a6000;
      }
      .status-missing {
        background: #fde4e1;
        color: #b3261e;
      }
      .objective-id {
        font-weight: 600;
        white-space: nowrap;
      }
      .small {
        font-size: 12px;
        color: #5c708a;
      }
      ul {
        padding-left: 20px;
      }
      .footer {
        margin-top: 48px;
        font-size: 12px;
        color: #5c708a;
      }
    </style>
  </head>
  <body>
    <header>
      <h1>{{planDefinition.title}}</h1>
      <p class="subtitle">{{planDefinition.purpose}}</p>
      <div class="summary-grid">
        <div class="summary-card">
          <strong>Project</strong>
          <span>{{projectLabel}}</span>
        </div>
        <div class="summary-card">
          <strong>Certification Level</strong>
          <span>{{levelLabel}}</span>
        </div>
        <div class="summary-card">
          <strong>Manifest ID</strong>
          <span>{{#if manifestId}}{{manifestId}}{{else}}Pending{{/if}}</span>
        </div>
        <div class="summary-card">
          <strong>Generated</strong>
          <span>{{generatedAt}}</span>
        </div>
      </div>
      <div class="summary-grid">
        <div class="summary-card">
          <strong>Objective Coverage</strong>
          <span>{{coverageSummary.coveredCount}}/{{coverageSummary.total}} ({{coverageSummary.coveragePercent}}%)</span>
        </div>
        <div class="summary-card">
          <strong>Verification Tests</strong>
          <span>{{stats.tests.total}} total · {{stats.tests.passed}} passed · {{stats.tests.failed}} failed · {{stats.tests.skipped}} skipped</span>
        </div>
        <div class="summary-card">
          <strong>Tracked Requirements</strong>
          <span>{{stats.requirements.total}}</span>
        </div>
        <div class="summary-card">
          <strong>Code Elements</strong>
          <span>{{stats.codePaths.total}}</span>
        </div>
      </div>
    </header>
    <section>
      <h2>Purpose &amp; Overview</h2>
      {{{overview}}}
    </section>
    {{#each sectionDefinitions as |section|}}
      <section>
        <h2>{{section.title}}</h2>
        {{{lookup ../sections section.id}}}
      </section>
    {{/each}}
    <section>
      <h2>Objective Coverage Summary</h2>
      <p>{{coverageSummary.text}}</p>
      <table>
        <thead>
          <tr>
            <th>Objective Table</th>
            <th>Total</th>
            <th>Covered</th>
            <th>Partial</th>
            <th>Missing</th>
          </tr>
        </thead>
        <tbody>
          {{#each tableSummary}}
            <tr>
              <td>{{table}}</td>
              <td>{{total}}</td>
              <td>{{covered}}</td>
              <td>{{partial}}</td>
              <td>{{missing}}</td>
            </tr>
          {{/each}}
        </tbody>
      </table>
    </section>
    <section>
      <h2>Detailed Objective Mapping</h2>
      <table>
        <thead>
          <tr>
            <th>Objective</th>
            <th>Table</th>
            <th>Description</th>
            <th>Status</th>
            <th>Evidence &amp; Gaps</th>
          </tr>
        </thead>
        <tbody>
          {{#each objectiveRows}}
            <tr>
              <td class="objective-id">{{id}}</td>
              <td>{{#if table}}{{table}}{{else}}—{{/if}}</td>
              <td>
                <strong>{{name}}</strong><br />
                <span class="small">{{description}}</span>
              </td>
              <td>
                <span class="status-pill {{statusClass}}">{{statusLabel}}</span>
              </td>
              <td>
                {{#if satisfiedArtifacts.length}}
                  <strong>Available:</strong> {{join satisfiedArtifacts ', '}}<br />
                {{/if}}
                {{#if missingArtifacts.length}}
                  <strong>Gaps:</strong> {{join missingArtifacts ', '}}<br />
                {{/if}}
                {{#if evidenceRefs.length}}
                  <span class="small">Refs: {{join evidenceRefs ', '}}</span>
                {{/if}}
              </td>
            </tr>
          {{/each}}
        </tbody>
      </table>
    </section>
    {{#if toolAssessment}}
      <section>
        <h2>Tool Assessment Summary</h2>
        <p>{{toolAssessment.summary}}</p>
        {{#if toolAssessment.classBreakdown.length}}
          <table>
            <thead>
              <tr>
                <th>Tool Class</th>
                <th>Count</th>
              </tr>
            </thead>
            <tbody>
              {{#each toolAssessment.classBreakdown}}
                <tr>
                  <td>{{toolClass}}</td>
                  <td>{{count}}</td>
                </tr>
              {{/each}}
            </tbody>
          </table>
        {{/if}}
        {{#if toolAssessment.arguments.length}}
          <h3>Qualification Arguments</h3>
          <ul>
            {{#each toolAssessment.arguments}}
              <li>{{this}}</li>
            {{/each}}
          </ul>
        {{/if}}
        {{#if toolAssessment.environmentNotes.length}}
          <h3>Execution Environment</h3>
          <ul>
            {{#each toolAssessment.environmentNotes}}
              <li>{{this}}</li>
            {{/each}}
          </ul>
        {{/if}}
        {{#if toolAssessment.tools.length}}
          <h3>Tool Inventory</h3>
          <table>
            <thead>
              <tr>
                <th>Tool ID</th>
                <th>Name &amp; Version</th>
                <th>Class</th>
                <th>Usage</th>
                <th>Qualification Summary</th>
                <th>Evidence</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody>
              {{#each toolAssessment.tools}}
                <tr>
                  <td>{{id}}</td>
                  <td>{{name}}{{#if version}} v{{version}}{{/if}}</td>
                  <td>{{toolClass}}</td>
                  <td>{{usage}}</td>
                  <td>{{#if qualificationSummary}}{{qualificationSummary}}{{else}}—{{/if}}</td>
                  <td>
                    {{#if evidence.length}}
                      <ul>
                        {{#each evidence}}
                          <li>{{this}}</li>
                        {{/each}}
                      </ul>
                    {{else}}
                      —
                    {{/if}}
                  </td>
                  <td>{{status}}</td>
                </tr>
              {{/each}}
            </tbody>
          </table>
        {{/if}}
        {{#if toolAssessment.signatures.length}}
          <h3>Tool Assessment Signatures</h3>
          <table>
            <thead>
              <tr>
                <th>Role</th>
                <th>Name</th>
                <th>Organization</th>
                <th>Date</th>
              </tr>
            </thead>
            <tbody>
              {{#each toolAssessment.signatures}}
                <tr>
                  <td>{{role}}</td>
                  <td>{{#if name}}{{name}}{{else}}—{{/if}}</td>
                  <td>{{#if organization}}{{organization}}{{else}}—{{/if}}</td>
                  <td>{{#if date}}{{date}}{{else}}—{{/if}}</td>
                </tr>
              {{/each}}
            </tbody>
          </table>
        {{/if}}
      </section>
    {{/if}}
    {{#if openObjectives.length}}
      <section>
        <h2>Open Compliance Items</h2>
        <p>{{openSummary}}</p>
        <ul>
          {{#each openObjectives}}
            <li>
              <strong>{{id}}</strong>
              — {{name}}
              (<span class="status-pill {{statusClass}}">{{statusLabel}}</span>)
            </li>
          {{/each}}
        </ul>
      </section>
    {{/if}}
    {{#if additionalNotes}}
      <section>
        <h2>Notes</h2>
        {{{additionalNotes}}}
      </section>
    {{/if}}
    <p class="footer">
      Generated by SOIPack {{packageVersion}} on {{generatedAt}} for {{projectLabel}}.
    </p>
  </body>
</html>
